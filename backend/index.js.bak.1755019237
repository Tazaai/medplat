// ~/medplat/backend/index.js
import express from "express";
import cors from "cors";

import topicsApi from "./routes/topics_api.mjs";
import dialogApi from "./routes/dialog_api.mjs";
import gamifyApi from "./routes/gamify_api.mjs";

const app = express();
app.set("trust proxy", true);

// ----- CORS (use env FRONTEND_ORIGIN for strict mode; allow all if unset) -----
const allowed = (process.env.FRONTEND_ORIGIN || "")
  .split(",")
  .map(s => s.trim())
  .filter(Boolean);

app.use(
  cors({
    origin: allowed.length ? allowed : true, // true => reflect request origin (debug-friendly)
    credentials: true,
  })
);

// ----- Body parsing BEFORE routes -----
app.use(express.json({ limit: "1mb" }));

// ----- Health & root -----
app.get("/healthz", (_req, res) => res.status(200).send("ok"));
app.get("/", (_req, res) =>
  res.status(200).json({
    ok: true,
    service: "medplat-backend",
    env: process.env.NODE_ENV || "development",
  })
);

// ----- Routes -----
app.use("/api/topics", topicsApi);
app.use("/api/dialog", dialogApi);
app.use("/api/gamify", gamifyApi);

// ----- Start -----
const PORT = process.env.PORT || 8080;
app.listen(PORT, () => {
  console.log(`ğŸš€ medplat-backend listening on ${PORT}`);
});
