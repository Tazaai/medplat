name: CI checks — backend tests + frontend build

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]
  pull_request:
    branches: [ '**' ]

jobs:
  preflight-checks:
    name: Preflight — required secrets
    runs-on: ubuntu-latest
    outputs:
      missing: ${{ steps.check-secrets.outputs.missing }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check required secrets
        id: check-secrets
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          FIREBASE_SERVICE_KEY: ${{ secrets.FIREBASE_SERVICE_KEY }}
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          VITE_API_BASE: ${{ secrets.VITE_API_BASE }}
          BACKEND_BASE: ${{ secrets.BACKEND_BASE }}
        run: |
          missing=0
          for s in OPENAI_API_KEY FIREBASE_SERVICE_KEY GCP_PROJECT GCP_SA_KEY VITE_API_BASE BACKEND_BASE; do
            if [ -z "${!s}" ]; then
              echo "ERROR: required secret $s is not set"
              missing=1
            else
              echo "OK: $s present"
            fi
          done
          echo "missing=$missing" >> "$GITHUB_OUTPUT"

      - name: Post PR comment when secrets missing
        if: ${{ github.event_name == 'pull_request' && steps.check-secrets.outputs.missing == '1' }}
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.payload.pull_request.number;
            const body = `⚠️ Preflight check failed: one or more required secrets are missing. Please set the repository secrets: OPENAI_API_KEY, FIREBASE_SERVICE_KEY, GCP_PROJECT, GCP_SA_KEY, VITE_API_BASE, BACKEND_BASE.`;
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number, body });

      - name: Fail if required secrets missing
        if: ${{ steps.check-secrets.outputs.missing == '1' }}
        run: |
          echo "One or more required secrets missing. Failing preflight.";
          exit 1

  backend-tests:
    name: Backend tests
    needs: preflight-checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ensure required secrets are set
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          FIREBASE_SERVICE_KEY: ${{ secrets.FIREBASE_SERVICE_KEY }}
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          VITE_API_BASE: ${{ secrets.VITE_API_BASE }}
          BACKEND_BASE: ${{ secrets.BACKEND_BASE }}
        run: |
          missing=0
          for s in OPENAI_API_KEY FIREBASE_SERVICE_KEY GCP_PROJECT GCP_SA_KEY VITE_API_BASE; do
            # BACKEND_BASE is optional for non-deploy CI runs; warn if missing but don't fail here
            if [ -z "${BACKEND_BASE}" ]; then
              echo "WARN: BACKEND_BASE not set — integration tests that target deployed backend will be skipped"
            fi
            if [ -z "${!s}" ]; then
              echo "ERROR: required secret $s is not set"
              missing=1
            else
              echo "OK: $s present"
            fi
          done
          if [ "$missing" -ne 0 ]; then
            echo "One or more required secrets are missing. Failing the job." >&2
            exit 1
          fi
      - name: Enforce read-only topics route
        run: |
          echo "Checking backend/routes/topics_api.mjs for write operations..."
          FILE=backend/routes/topics_api.mjs
          if [ -f "$FILE" ]; then
            if grep -nE "\b(add\(|\.set\(|\.update\(|\.delete\(|\bset\b|\bupdate\b|\bdelete\b)" "$FILE" >/dev/null; then
              echo "ERROR: write operation found in $FILE — topics route must be read-only" >&2
              grep -nE "\b(add\(|\.set\(|\.update\(|\.delete\(|\bset\b|\bupdate\b|\bdelete\b)" "$FILE" >&2 || true
              exit 1
            else
              echo "No write verbs found in $FILE"
            fi
          else
            echo "File $FILE not found — skipping read-only check"
          fi
      - name: Use Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install backend deps
        run: npm --prefix backend ci
      - name: Run backend tests
        run: npm --prefix backend test

  frontend-build:
    name: Frontend build
    runs-on: ubuntu-latest
    needs: backend-tests
    steps:
      - uses: actions/checkout@v4
      - name: Use Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install frontend deps
        run: npm --prefix frontend ci
      - name: Build frontend (safe)
        env:
          # Use a safe fallback backend URL so build doesn't require secrets
          VITE_API_BASE: 'https://example.com'
        run: |
          npm --prefix frontend run build
      - name: Upload frontend dist
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

  enhanced-diagnostics:
    name: Enhanced diagnostics and artifacts
    runs-on: ubuntu-latest
    needs: frontend-build
    steps:
      - uses: actions/checkout@v4
      - name: Use Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Run enhanced diagnostics
        run: |
          node scripts/review_report_enhanced.mjs || true
          mkdir -p artifacts
          cp tmp/logs/agent_enhanced_*.md artifacts/ || true
      - name: Upload diagnostic artifact
        uses: actions/upload-artifact@v4
        with:
          name: agent-enhanced-report
          path: artifacts/
      - name: Remind commit policy
        run: |
          echo "⚠️ Reminder: before deploying to Cloud Run or production, ensure the latest code is merged into main."
          echo "   Use: git checkout main && git pull origin main"
          echo "   Then re-run the deployment workflow."

      - name: Trim enhanced report for PR comment
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          mkdir -p tmp/logs
          LATEST=$(ls -1t tmp/logs/agent_enhanced_*.md 2>/dev/null | head -n 1 || true)
          if [ -n "$LATEST" ]; then
            # Prefer a 40-line summary; fall back to full file if head fails for any reason
            head -n 40 "$LATEST" > tmp/logs/agent_enhanced_latest.md || cp "$LATEST" tmp/logs/agent_enhanced_latest.md
          else
            echo "No enhanced report found for this run." > tmp/logs/agent_enhanced_latest.md
          fi

      - name: Post enhanced diagnostics summary to PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-file: tmp/logs/agent_enhanced_latest.md
          token: ${{ secrets.GITHUB_TOKEN }}

  integration:
    name: Integration tests (topics search)
    runs-on: ubuntu-latest
    needs: enhanced-diagnostics
    steps:
      - uses: actions/checkout@v4
      - name: Use Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Run integration test for topics search
        env:
          BACKEND_BASE: ${{ secrets.BACKEND_BASE }}
        run: |
          if [ -z "${BACKEND_BASE}" ]; then
            echo "Skipping integration tests: BACKEND_BASE not set";
            exit 0;
          fi
          node test/integration/topics_search_integration.mjs
