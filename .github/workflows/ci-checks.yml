name: CI Checks - Connectivity Smoke

on:
  workflow_dispatch:
    inputs:
      backend-url:
        description: 'Backend base URL (e.g., https://my-backend-url)'
        required: true
        default: 'http://localhost:8080'

jobs:
  connectivity-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run connectivity check
        run: |
          mkdir -p logs
          bash scripts/check_connectivity.sh "${{ github.event.inputs.backend-url }}"

      - name: Upload connectivity log
        uses: actions/upload-artifact@v4
        with:
          name: connectivity-log
          path: logs/*
name: CI checks â€” backend tests + frontend build

on:
  workflow_dispatch: {}
  pull_request:
    branches: [ '**' ]

jobs:
  preflight-checks:
    name: Preflight â€” required secrets
    runs-on: ubuntu-latest
    outputs:
      missing: ${{ steps.check-secrets.outputs.missing }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check required secrets
        id: check-secrets
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          FIREBASE_SERVICE_KEY: ${{ secrets.FIREBASE_SERVICE_KEY }}
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          VITE_API_BASE: ${{ secrets.VITE_API_BASE }}
          BACKEND_BASE: ${{ secrets.BACKEND_BASE }}
        run: |
          missing=0
          missing_list=""
          for s in OPENAI_API_KEY FIREBASE_SERVICE_KEY GCP_PROJECT GCP_SA_KEY VITE_API_BASE BACKEND_BASE; do
            if [ -z "${!s}" ]; then
              echo "ERROR: required secret $s is not set"
              if [ -z "$missing_list" ]; then
                missing_list="$s"
              else
                missing_list="$missing_list,$s"
              fi
              missing=1
            else
              echo "OK: $s present"
            fi
          done
          echo "missing=$missing" >> "$GITHUB_OUTPUT"
          echo "missing_list=$missing_list" >> "$GITHUB_OUTPUT"

      - name: Comment missing secrets on PR
        if: ${{ github.event_name == 'pull_request' && steps.check-secrets.outputs.missing == '1' }}
        uses: actions/github-script@v7
        env:
          MISSING_SECRETS: ${{ steps.check-secrets.outputs.missing_list }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const missing = process.env.MISSING_SECRETS || 'unknown';
            const body = `ðŸš¨ **CI Preflight Check Failed**  \nMissing required secrets: \`${missing}\`  \nPlease set them under **Settings â†’ Secrets â†’ Actions**.`;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Fail if required secrets missing
        if: ${{ steps.check-secrets.outputs.missing == '1' }}
        run: |
          echo "One or more required secrets missing. Failing preflight.";
          exit 1

  backend-tests:
    name: Backend tests
    needs: preflight-checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ensure required secrets are set
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          FIREBASE_SERVICE_KEY: ${{ secrets.FIREBASE_SERVICE_KEY }}
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          VITE_API_BASE: ${{ secrets.VITE_API_BASE }}
          BACKEND_BASE: ${{ secrets.BACKEND_BASE }}
        run: |
          missing=0
          for s in OPENAI_API_KEY FIREBASE_SERVICE_KEY GCP_PROJECT GCP_SA_KEY VITE_API_BASE; do
            # BACKEND_BASE is optional for non-deploy CI runs; warn if missing but don't fail here
            if [ -z "${BACKEND_BASE}" ]; then
              echo "WARN: BACKEND_BASE not set â€” integration tests that target deployed backend will be skipped"
            fi
            if [ -z "${!s}" ]; then
              echo "ERROR: required secret $s is not set"
              missing=1
            else
              echo "OK: $s present"
            fi
          done
          if [ "$missing" -ne 0 ]; then
            echo "One or more required secrets are missing. Failing the job." >&2
            exit 1
          fi
      - name: Enforce read-only topics route
        run: |
          echo "Checking backend/routes/topics_api.mjs for write operations..."
          FILE=backend/routes/topics_api.mjs
          if [ -f "$FILE" ]; then
            # Be conservative but avoid false positives (e.g. local Set.add or other non-Firestore uses).
            # Only flag writes that clearly target a Firestore collection/doc (collection(...).add/set/update/delete)
            if grep -nE "\.collection\([^)]*(topics2|collectionName)[^)]*\)\.(add|doc\(|set\(|update\(|delete\()|admin\.firestore\(\).*\.(add|set\(|update\(|delete\()" "$FILE" >/dev/null; then
              echo "ERROR: potential Firestore write operation found in $FILE â€” topics route must be read-only" >&2
              grep -nE "\.collection\([^)]*(topics2|collectionName)[^)]*\)\.(add|doc\(|set\(|update\(|delete\()|admin\.firestore\(\).*\.(add|set\(|update\(|delete\()" "$FILE" >&2 || true
              exit 1
            else
              echo "No Firestore write calls found in $FILE"
            fi
          else
            echo "File $FILE not found â€” skipping read-only check"
          fi
      - name: Use Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install backend deps
        run: npm --prefix backend ci
      - name: Run backend tests
        run: npm --prefix backend test

  frontend-build:
    name: Frontend build
    needs: preflight-checks
    runs-on: ubuntu-latest
    needs: backend-tests
    steps:
      - uses: actions/checkout@v4
      - name: Use Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install frontend deps
        run: npm --prefix frontend ci
      - name: Build frontend (safe)
        env:
          BACKEND_BASE: ${{ secrets.BACKEND_BASE }}
        run: |
          # Prefer BACKEND_BASE secret (deployed backend) for the built frontend.
          if [ -n "${BACKEND_BASE}" ]; then
            echo "Using BACKEND_BASE for VITE_API_BASE: ${BACKEND_BASE}"
            export VITE_API_BASE="${BACKEND_BASE}"
          else
            echo "BACKEND_BASE not set; falling back to known deployed backend"
            export VITE_API_BASE='https://medplat-backend-139218747785.europe-west1.run.app'
          fi
          npm --prefix frontend run build
      - name: Upload frontend dist
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

  enhanced-diagnostics:
    name: Enhanced diagnostics and artifacts
    runs-on: ubuntu-latest
    needs: frontend-build
    steps:
      - uses: actions/checkout@v4
      - name: Use Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Run enhanced diagnostics
        run: |
          node scripts/review_report_enhanced.mjs || true
          mkdir -p artifacts
          cp tmp/logs/agent_enhanced_*.md artifacts/ || true
      - name: Upload diagnostic artifact
        uses: actions/upload-artifact@v4
        with:
          name: agent-enhanced-report
          path: artifacts/
      - name: Remind commit policy
        run: |
          echo "âš ï¸ Reminder: before deploying to Cloud Run or production, ensure the latest code is merged into main."
          echo "   Use: git checkout main && git pull origin main"
          echo "   Then re-run the deployment workflow."

      - name: Trim enhanced report for PR comment
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          mkdir -p tmp/logs
          LATEST=$(ls -1t tmp/logs/agent_enhanced_*.md 2>/dev/null | head -n 1 || true)
          if [ -n "$LATEST" ]; then
            # Prefer a 40-line summary; fall back to full file if head fails for any reason
            head -n 40 "$LATEST" > tmp/logs/agent_enhanced_latest.md || cp "$LATEST" tmp/logs/agent_enhanced_latest.md
          else
            echo "No enhanced report found for this run." > tmp/logs/agent_enhanced_latest.md
          fi

      - name: Post enhanced diagnostics summary to PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-file: tmp/logs/agent_enhanced_latest.md
          token: ${{ secrets.GITHUB_TOKEN }}

  integration:
    name: Integration tests (topics search)
    runs-on: ubuntu-latest
    needs: enhanced-diagnostics
    steps:
      - uses: actions/checkout@v4
      - name: Use Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Run integration test for topics search
        env:
          BACKEND_BASE: ${{ secrets.BACKEND_BASE }}
        run: |
          if [ -z "${BACKEND_BASE}" ]; then
            echo "Skipping integration tests: BACKEND_BASE not set";
            exit 0;
          fi
          node test/integration/topics_search_integration.mjs

  post_deploy_smoke:
    name: Post-Deploy Connectivity Smoke Check
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify deployed backend connectivity
        env:
          BACKEND_BASE: ${{ secrets.BACKEND_BASE }}
          VITE_API_BASE: ${{ secrets.VITE_API_BASE }}
        run: |
          # Prefer BACKEND_BASE (explicit deployed backend). Fall back to VITE_API_BASE.
          if [ -n "$BACKEND_BASE" ]; then
            BASE_URL="$BACKEND_BASE"
          elif [ -n "$VITE_API_BASE" ]; then
            BASE_URL="$VITE_API_BASE"
          else
            echo "ERROR: Neither BACKEND_BASE nor VITE_API_BASE is set. Cannot run post-deploy smoke check." >&2
            exit 1
          fi

          echo "Running connectivity check against $BASE_URL ..."
          mkdir -p logs
          bash scripts/check_connectivity.sh "$BASE_URL" || {
            echo "âŒ Connectivity check failed for $BASE_URL" >&2
            # Upload the logs to help debugging (artifact upload is available in other workflows)
            ls -la logs || true
            cat logs/* || true
            exit 1
          }

      - name: Upload connectivity logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: connectivity-logs
          path: logs/*

