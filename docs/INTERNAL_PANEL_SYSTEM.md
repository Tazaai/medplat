# Internal Dynamic Expert Panel System

## Overview
Every case generated by MedPlat is **automatically reviewed and improved** by an internal expert panel BEFORE being shown to users. This invisible quality layer ensures all cases meet high clinical and educational standards.

## Architecture

### Case Generation Flow
```
User Request → Draft Case (GPT-4o-mini)
    ↓
Internal Panel Review (GPT-4o-mini + dynamic experts)
    ↓
Improved Case → User sees refined version
    ↓
Optional: External Panel (manual developer review)
```

## Panel Composition

### Permanent Members (every case)
1. **Medical Student** - Learning perspective, identifies confusing elements
2. **Professor** - Academic rigor, teaching quality
3. **Researcher** - Evidence-based medicine validation

### Dynamic Specialists (auto-selected by topic/category)

| Category | Specialists (4 roles) |
|----------|----------------------|
| **Cardiology** | Cardiologist, Emergency Physician, Internist, Cardiac Surgeon |
| **Neurology** | Neurologist, Neuroradiologist, Internal Medicine, Emergency Physician |
| **Pulmonology** | Pulmonologist, Critical Care Specialist, Emergency Physician, Thoracic Surgeon |
| **Gastroenterology** | Gastroenterologist, General Surgeon, Emergency Physician, Hepatologist |
| **Nephrology** | Nephrologist, Internist, Emergency Physician, Urologist |
| **Endocrinology** | Endocrinologist, Internist, Emergency Physician, Clinical Pharmacist |
| **Infectious Disease** | ID Specialist, Intensivist, Emergency Physician, Clinical Microbiologist |
| **Hematology/Oncology** | Hematologist, Oncologist, Internist, Emergency Physician |
| **Rheumatology** | Rheumatologist, Internist, Emergency Physician, Clinical Immunologist |
| **Trauma/Orthopedics** | Trauma Surgeon, Orthopedic Surgeon, Emergency Physician, Anesthesiologist |
| **Toxicology** | Toxicologist, Clinical Pharmacist, Emergency Physician, Intensivist |
| **Psychiatry** | Psychiatrist, Emergency Physician, Clinical Psychologist, Neurologist |

**Total:** 7 experts per case (3 permanent + 4 dynamic)

## Review Focus

The internal panel improves cases by:
- ✅ Ensuring clinical accuracy and guideline adherence (region-specific)
- ✅ Adding missing critical elements (red flags, timing windows, rescue therapies)
- ✅ Clarifying differential diagnoses reasoning
- ✅ Verifying hemodynamic profiling (warm/cold, wet/dry)
- ✅ Enriching labs/imaging with realistic timing and rationale
- ✅ Validating evidence-based data (prevalence, test characteristics)
- ✅ Improving teaching pearls and mnemonics quality
- ✅ Ensuring social needs and disposition are region-appropriate

## User Experience

**What users see:**
```json
{
  "case": { ... comprehensive case data ... },
  "meta": {
    "panelNote": "✅ Reviewed by internal specialist panel"
  }
}
```

**What users DON'T see:**
- Panel discussion details
- Individual expert opinions
- Corrections made to draft

## Implementation

### API Endpoints
- **`/api/cases`** - Generates case + auto-triggers internal panel
- **`/api/internal-panel`** - Internal review endpoint (not called directly by users)

### Code Location
- `backend/routes/internal_panel_api.mjs` - Panel logic
- `backend/routes/cases_api.mjs` - Integration into case generation

### Backend Revision
- **Deployed:** `medplat-backend-00977-d4p`
- **Region:** `europe-west1`
- **Model:** GPT-4o-mini (fast, cost-effective)

## Testing

### Test Commands
```bash
# Test with specific category
curl -X POST https://medplat-backend-139218747785.europe-west1.run.app/api/cases \
  -H "Content-Type: application/json" \
  -d '{"topic":"Sepsis","category":"Infectious Disease","language":"en","region":"EU/DK"}' \
  | jq '.case.meta.panelNote'

# Expected: "✅ Reviewed by internal specialist panel"
```

### Verified Results
- ✅ Sepsis (ID panel): 4 red flags, 2+ teaching pearls
- ✅ Acute Stroke (Neuro panel): 5 differentials, evidence included
- ✅ STEMI (Cardiology panel): 4 red flags, 3 teaching pearls
- ✅ Pneumonia (Pulm panel): 6 differentials, evidence included

## Performance

- **Average latency:** +5-10s per case (internal review adds minimal overhead)
- **Fallback:** If panel unavailable, returns draft with warning note
- **Cost:** ~$0.002 per case review (GPT-4o-mini tokens)

## Difference from External Panel

| Feature | Internal Panel | External Panel |
|---------|---------------|----------------|
| **Visibility** | Invisible to users | Visible (manual request ONLY) |
| **Trigger** | Automatic (every case) | **Manual copy/paste to ChatGPT** |
| **Purpose** | Quality assurance | System improvement feedback |
| **Integration** | ✅ Integrated in project code | ❌ NOT integrated (manual use only) |
| **Output** | Improved case JSON | Text review with suggestions |
| **Roles** | 7 clinical experts | 12 experts (clinical + technical) |
| **Model** | GPT-4o-mini | GPT-4o (when used manually) |
| **Endpoint** | `/api/internal-panel` | `/api/expert-panel` (for manual use) |
| **Workflow** | Backend auto-calls during case generation | Developer manually copies case → pastes to ChatGPT |

**IMPORTANT:** The external panel (`/api/expert-panel`) is **NOT** automatically triggered. It exists only for developers to manually request reviews for system improvements, not for end-user workflow.

## Future Enhancements

- [ ] Metrics dashboard: track panel corrections per category
- [ ] A/B testing: draft vs reviewed case quality scores
- [ ] User feedback: "Was this case helpful?" → correlate with panel notes
- [ ] Adaptive thresholds: skip panel for simple topics, double-review for complex
- [ ] Panel memory: learn from user interactions to improve future reviews

---
*Last updated: November 7, 2025 — Backend revision: medplat-backend-00977-d4p*
