# ğŸš€ **MedPlat â€” Complete Project Guide for Cursor (2025 Edition)**

**Dynamic AI Medical Case Platform â€” Backend + Frontend + Firestore + Cloud Run**

This guide tells Cursor EXACTLY how the MedPlat project works, what rules to follow, and how to automate everything without mistakes.

---

# ğŸ“Œ **1. Project Structure**

```
medplat/
 â”œâ”€â”€ backend/
 â”‚    â”œâ”€â”€ index.js
 â”‚    â”œâ”€â”€ routes/
 â”‚    â”‚     â”œâ”€â”€ topics_api.mjs (topics2 endpoints)
 â”‚    â”‚     â”œâ”€â”€ dialog_api.mjs
 â”‚    â”‚     â”œâ”€â”€ gamify_api.mjs
 â”‚    â”‚     â”œâ”€â”€ mentor_api.mjs
 â”‚    â”‚     â”œâ”€â”€ panel_api.mjs
 â”‚    â”‚     â”œâ”€â”€ internal_panel_api.mjs
 â”‚    â”‚     â”œâ”€â”€ reasoning_api.mjs
 â”‚    â”‚     â”œâ”€â”€ comment_api.mjs
 â”‚    â”‚     â”œâ”€â”€ quickref_api.mjs
 â”‚    â”‚     â”œâ”€â”€ translation_api.mjs
 â”‚    â”‚     â”œâ”€â”€ voice_api.mjs
 â”‚    â”‚     â””â”€â”€ analytics_dashboard_api.mjs
 â”‚    â”œâ”€â”€ firebaseClient.js
 â”‚    â”œâ”€â”€ openaiClient.js
 â”‚    â””â”€â”€ package.json
 â”‚
 â”œâ”€â”€ frontend/
 â”‚    â”œâ”€â”€ src/
 â”‚    â”‚    â”œâ”€â”€ CaseView.jsx
 â”‚    â”‚    â”œâ”€â”€ Level2CaseLogic.jsx
 â”‚    â”‚    â”œâ”€â”€ DialogChat.jsx
 â”‚    â”‚    â”œâ”€â”€ CaseList.jsx
 â”‚    â”‚    â”œâ”€â”€ config.js
 â”‚    â”‚    â””â”€â”€ utils/
 â”‚    â”‚         â””â”€â”€ categoryLoader.js
 â”‚    â”œâ”€â”€ package.json
 â”‚    â””â”€â”€ Dockerfile
 â”‚
 â”œâ”€â”€ scripts/
 â”‚    â”œâ”€â”€ clean_topics2.mjs
 â”‚    â”œâ”€â”€ fix_topics2_structure_final.mjs
 â”‚    â”œâ”€â”€ add_categories_and_topics.mjs
 â”‚    â”œâ”€â”€ validate_dynamic_routes.mjs
 â”‚    â”œâ”€â”€ deploy.ps1
 â”‚    â””â”€â”€ deploy.sh
 â”‚
 â”œâ”€â”€ .cursorrules
 â””â”€â”€ PROJECT_GUIDE_CURSOR.md
```

---

# ğŸ“Œ **2. Core Philosophy**

The **entire platform is 100% dynamic**:

âœ” All topics come from Firestore `topics2` collection  
âœ” All cases are generated live by OpenAI (no templates)  
âœ” All MCQs generated by OpenAI (bulk or step-based)  
âœ” All guidelines retrieved dynamically  
âœ” No static JSON files  
âœ” No static case lists  
âœ” No static categories  

Cursor must **never** add static files unless explicitly instructed.

---

# ğŸ“Œ **3. Firestore Specification**

### Collection: `topics2`

**âœ… Standard Structure (FINAL - 2025):**

Each document MUST follow this **exact** structure:

```json
{
  "id": "acute_abdomen",
  "topic": "Acute Abdomen",
  "category": "Acute Medicine",
  "keywords": {
    "topic": "Acute Abdomen"
  }
}
```

### **Required Fields:**
- âœ… `id` - **string**, snake_case (e.g., `"acute_abdomen"`)
- âœ… `topic` - **string**, Title Case (e.g., `"Acute Abdomen"`)
- âœ… `category` - **string** (e.g., `"Acute Medicine"`)
- âœ… `keywords` - **object** (NOT array), must have `topic` key

### **Fields REMOVED (DO NOT USE):**
- âŒ `lang` - **REMOVED** (no longer exists)
- âŒ `difficulty` - **REMOVED** (no longer exists)
- âŒ `area` - **REMOVED** (no longer exists)
- âŒ Any other extra fields - **REMOVED**

### **Structure Rules:**
1. **IDs must be snake_case** - `"acute_abdomen"`, not `"Acute Abdomen"` or `"acute-abdomen"`
2. **Topics must be Title Case** - `"Acute Abdomen"`, not `"acute abdomen"` or `"ACUTE ABDOMEN"`
3. **Keywords MUST be object** - `{ topic: "Topic Name" }`, NOT array `["Topic", "Name"]`
4. **No duplicates** - No duplicate IDs or topic+category combinations
5. **All categories come from Firestore** - No hardcoded category lists

### **Example Valid Documents:**

```json
// Psychiatry
{
  "id": "nicotine_dependence",
  "topic": "Nicotine Dependence",
  "category": "Psychiatry",
  "keywords": {
    "topic": "Nicotine Dependence"
  }
}

// ALS
{
  "id": "4_hs_and_4_ts",
  "topic": "4 Hs and 4 Ts",
  "category": "ALS",
  "keywords": {
    "topic": "4 Hs and 4 Ts"
  }
}

// Orthopedics
{
  "id": "achilles_tendon_rupture_assessment",
  "topic": "Achilles Tendon Rupture Assessment",
  "category": "Orthopedics",
  "keywords": {
    "topic": "Achilles Tendon Rupture Assessment"
  }
}
```

### **Creating New Topics:**

When creating new topics, use this structure:

```javascript
const newTopic = {
  id: toSnakeCase(topicName),        // "acute_abdomen"
  topic: topicName,                  // "Acute Abdomen" (Title Case)
  category: categoryName,            // "Acute Medicine"
  keywords: {
    topic: topicName                  // "Acute Abdomen"
  }
  // DO NOT include:
  // - lang
  // - difficulty
  // - area
  // - any other fields
};
```

### **Validation:**
Cursor must run `scripts/fix_topics2_structure_final.mjs` to ensure all documents follow this structure.

---

# ğŸ“Œ **4. Backend Rules (Cloud Run)**

### **Backend URL (ALWAYS USE):**
```
https://medplat-backend-139218747785.europe-west1.run.app
```

### **ONLY Valid Endpoints (Dynamic-Only):**

```
POST /api/topics2                    # Get topics from Firestore
POST /api/topics2/categories        # Get all categories from Firestore
POST /api/dialog                    # Generate case with OpenAI
POST /api/gamify                    # Generate MCQs with OpenAI
POST /api/mentor                    # Mentor chat endpoint
POST /api/panel                     # Panel endpoint
POST /api/internal-panel             # Internal panel endpoint
POST /api/reasoning                 # Reasoning endpoint
POST /api/comment                   # Comment endpoint
POST /api/translation                # Translation endpoint
POST /api/quickref                  # Quick reference endpoint
POST /api/voice                     # Voice endpoint
POST /api/analytics_dashboard        # Analytics endpoint
GET  /api/health                    # Health check (optional)
```

### **Forbidden Endpoints (Must Remain Deleted):**

```
GET /api/topics                     # âŒ REMOVED (legacy static)
GET /api/topics/categories          # âŒ REMOVED (legacy static)
/static-glossary.json               # âŒ REMOVED (static file)
/static-topics.json                 # âŒ REMOVED (static file)
/cases/                             # âŒ REMOVED (static cases)
```

### **Mounting in `backend/index.js`:**

```javascript
// âœ… Dynamic imports only
async function mountRoutes() {
  const [topicsMod, dialogMod, gamifyMod, ...] = await Promise.all([
    import('./routes/topics_api.mjs'),
    import('./routes/dialog_api.mjs'),
    import('./routes/gamify_api.mjs'),
    // ...
  ]);
  
  app.use("/api/topics2", normalizeRouter(topicsMod));
  app.use("/api/dialog", normalizeRouter(dialogMod));
  app.use("/api/gamify", normalizeRouter(gamifyMod));
  // ...
}
```

### **Validation Tests:**

Cursor should run after deployment:
```bash
node scripts/validate_dynamic_routes.mjs
```

---

# ğŸ“Œ **5. Frontend Rules**

### **Backend URL Configuration:**

**File:** `frontend/src/config.js`
```javascript
// Production default: europe-west1 backend
API_BASE = 'https://medplat-backend-139218747785.europe-west1.run.app';
```

**File:** `frontend/Dockerfile`
```dockerfile
ENV VITE_BACKEND_URL=https://medplat-backend-139218747785.europe-west1.run.app
ENV VITE_API_BASE=https://medplat-backend-139218747785.europe-west1.run.app
```

### **Category Loading (POST-Only):**

**File:** `frontend/src/utils/categoryLoader.js`
```javascript
// âœ… ALWAYS use POST for categories
export async function loadCategories() {
  const response = await fetch(`${API_BASE}/api/topics2/categories`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({})
  });
  // ...
}
```

### **Case Generation:**
```javascript
POST /api/dialog
```

### **Gamification:**
```javascript
POST /api/gamify
```

### **Never Use:**
- âŒ GET requests to backend (except health checks)
- âŒ Old endpoints `/api/topics`
- âŒ Local static lists of topics
- âŒ Fallback category arrays
- âŒ Hardcoded topic lists

---

# ğŸ“Œ **6. Deployment Rules (Cursor must follow)**

### **Backend Deployment:**

```bash
cd backend
gcloud builds submit --tag gcr.io/medplat-458911/medplat-backend --project medplat-458911
gcloud run deploy medplat-backend \
  --image gcr.io/medplat-458911/medplat-backend \
  --region europe-west1 \
  --allow-unauthenticated \
  --set-secrets "FIREBASE_SERVICE_KEY=FIREBASE_SERVICE_KEY:latest,OPENAI_API_KEY=OPENAI_API_KEY:latest" \
  --update-env-vars "GCP_PROJECT=medplat-458911,TOPICS_COLLECTION=topics2,NODE_ENV=production" \
  --project medplat-458911
```

### **Frontend Deployment:**

```bash
cd frontend
# Delete dist and node_modules
rm -rf dist node_modules
npm install
npm run build
# Verify VITE_BACKEND_URL in build output
gcloud builds submit --tag gcr.io/medplat-458911/medplat-frontend --project medplat-458911
gcloud run deploy medplat-frontend \
  --image gcr.io/medplat-458911/medplat-frontend \
  --region europe-west1 \
  --allow-unauthenticated \
  --set-env-vars "VITE_API_BASE=https://medplat-backend-139218747785.europe-west1.run.app" \
  --project medplat-458911
```

### **Before Deploying, Cursor MUST:**

1. âœ… **Run lint + validate routes**
2. âœ… **Confirm VITE_API_BASE uses correct backend URL** (`https://medplat-backend-139218747785.europe-west1.run.app`)
3. âœ… **Check for leftover static files** (no `/static-*.json`, no `/cases/`)
4. âœ… **Verify `/api/topics2/categories` exists** (POST endpoint)
5. âœ… **Check Firestore structure** (no `lang`, no `difficulty`, no `area`)

---

# ğŸ“Œ **7. Cursor Automation Rules**

Cursor must automatically do these:

### **When I say "deploy":**
1. Validate backend routes
2. Deploy backend to Cloud Run
3. Validate frontend build (check VITE_API_BASE)
4. Deploy frontend to Cloud Run
5. Test all dynamic endpoints
6. Verify Firestore structure
7. Show deployment URLs

### **When I say "clean topics2":**
1. Run `scripts/clean_topics2.mjs`
2. Generate report
3. Fix duplicates, remove Radiology, correct structure
4. Ensure no `lang`, `difficulty`, or `area` fields

### **When I say "fix topics2 structure":**
1. Run `scripts/fix_topics2_structure_final.mjs`
2. Remove `lang`, `difficulty`, `area` fields
3. Fix duplicate `topic` fields
4. Standardize `keywords` to objects
5. Verify all documents have correct structure

### **When I say "remove static endpoints":**
1. Delete ALL static routes
2. Update backend mounts
3. Update frontend calls
4. Validate dynamic-only routing
5. Remove static JSON files

### **When I say "fix categories":**
1. Check Firestore categories
2. Regenerate categories list from Firestore
3. Ensure frontend reflects them correctly
4. Use POST `/api/topics2/categories` only

---

# ğŸ“Œ **8. Health & Diagnostics**

Cursor must run these checks:

```bash
# Backend health
curl -X POST https://medplat-backend-139218747785.europe-west1.run.app/api/topics2/categories

# Dynamic endpoints
curl -X POST https://medplat-backend-139218747785.europe-west1.run.app/api/dialog
curl -X POST https://medplat-backend-139218747785.europe-west1.run.app/api/gamify
```

If ANY return 404 â†’ fix router mounts in `backend/index.js`.

---

# ğŸ“Œ **9. Rules for Editing Code**

Cursor must:

âœ” Show entire file before modifying  
âœ” Apply minimal, precise patches  
âœ” NEVER recreate files unless asked  
âœ” NEVER remove AI logic  
âœ” NEVER add static lists  
âœ” NEVER switch POST â†’ GET  
âœ” Only touch dynamic routes unless instructed  
âœ” NEVER add `lang`, `difficulty`, or `area` fields to topics2  
âœ” Always ensure `keywords` is an object with `topic` key  

---

# ğŸ“Œ **10. What Cursor Should Always Watch For**

- âŒ Wrong region (`us-central1` must NEVER appear)
- âŒ Wrong API routes (`/api/topics` must NEVER return 200)
- âŒ Wrong VITE_API_BASE injection
- âŒ Missing Firestore documents
- âŒ Broken router imports in `index.js`
- âŒ Missing `export default router`
- âŒ Documents with `lang`, `difficulty`, or `area` fields
- âŒ `keywords` as arrays instead of objects
- âŒ Duplicate `topic` fields in documents
- âŒ GET requests for categories (must be POST)

---

# ğŸ“Œ **11. Quick Commands (Triggers)**

| Command                     | Action                              |
| --------------------------- | ----------------------------------- |
| **deploy**                  | Full backend + frontend deploy      |
| **deploy backend**          | Deploy backend only                 |
| **deploy frontend**         | Deploy frontend only                |
| **clean topics2**           | Normalize all Firestore topics      |
| **fix topics2 structure**   | Fix structure (remove lang/difficulty/area) |
| **remove static endpoints** | Delete legacy topics endpoints      |
| **fix categories**          | Repair category list from Firestore |
| **validate routes**         | Run dynamic route validator         |
| **repair backend**          | Fix router mounts and imports       |
| **fix VITE_API_BASE**       | Ensure correct backend URL          |

---

# ğŸ“Œ **12. Firestore Structure Validation**

### **Scripts Available:**

1. **`scripts/fix_topics2_structure_final.mjs`**
   - Removes `lang`, `difficulty`, `area` fields
   - Fixes duplicate `topic` fields
   - Standardizes `keywords` to objects
   - Ensures consistent structure

2. **`scripts/clean_topics2.mjs`**
   - Removes duplicates
   - Removes Radiology category
   - Normalizes categories and IDs
   - Validates structure

3. **`scripts/add_categories_and_topics.mjs`**
   - Adds new categories with topics
   - Uses correct structure (no lang, no difficulty)
   - Ensures `keywords` is object

### **Running Structure Fix:**

```bash
# Get Firebase credentials
$key = gcloud secrets versions access latest --secret="FIREBASE_SERVICE_KEY" --project="medplat-458911"
$env:FIREBASE_SERVICE_KEY = $key

# Run structure fix
node scripts/fix_topics2_structure_final.mjs
```

---

# ğŸ“Œ **13. Final Rule**

Cursor must ALWAYS assume:

**MedPlat is a dynamic AI-driven platform.**
- âœ… No static data
- âœ… No static topics
- âœ… No static categories
- âœ… No `lang` field in topics2
- âœ… No `difficulty` field in topics2
- âœ… No `area` field in topics2
- âœ… `keywords` is always an object with `topic` key
- âœ… All topics come from Firestore
- âœ… All cases generated by OpenAI
- âœ… All categories loaded dynamically

---

# ğŸ“Œ **14. Standard Categories (Reference)**

Current categories in Firestore (as of 2025):
- Acute Medicine
- Addiction Medicine
- ALS
- Allergy & Immunology
- Anesthesiology
- Cardiology
- Critical Care / ICU Medicine
- Dermatology
- Disaster & Crisis Response
- Emergency Medicine
- Endocrinology
- ENT / Otolaryngology
- Family Medicine
- Forensic Medicine
- Gastroenterology
- General Practice
- Geriatrics
- Hematology
- Infectious Diseases
- Medical Ethics
- Medical Genetics
- Nephrology
- Neurology
- Nutrition & Metabolism
- Obstetrics & Gynecology
- Occupational Medicine
- Oncology
- Ophthalmology
- Orthopedics
- Palliative Medicine
- Pediatrics
- Preventive Medicine
- Psychiatry
- Public Health
- Pulmonology
- Rehabilitation Medicine
- Rheumatology
- Sleep Medicine
- Sports Medicine
- Toxicology
- Travel Medicine
- Urology
- Wilderness Medicine

**Note:** Categories are loaded dynamically from Firestore. Do NOT hardcode this list.

---

**âœ… This guide is the single source of truth for MedPlat development.**

